name: Security Monitoring


# ------------------------------------------------------------------------------


on:
  pull_request:
  workflow_dispatch:
  schedule:
    - cron: '0 2 * * *'


# ------------------------------------------------------------------------------


concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true


# ------------------------------------------------------------------------------


jobs:

  # Job
  security-suite:
    name: Tests (NodeJs ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        node-version: [ 18, 20 ]
    timeout-minutes: 5
    steps:

      # Step
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      # Step
      - name: Setup the NodeJs Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm

      # Step
      # ----
      # This step will run the Unit Test suite via Jest (Security Suites).
      # If no tests are implemented, this step will still succeed. Once finished
      # an artifact will always be uploaded for each concurrent matrix with test
      # results in a plain-text format.
      # ----
      - name: Execute the Jest Unit Testing
        shell: bash
        run: |
          npm ci --prefer-offline --no-audit --no-fund
          mkdir -p test-results coverage
          npm run test:security -- --coverage --passWithNoTests --json --outputFile=test-results/jest-results.json
          npx jest tests/security --coverageReporters=text-summary > test-results/coverage-summary.txt || true

      # Step
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jest-test-results-node-${{ matrix.node-version }}
          retention-days: 7
          path: |
            test-results/
            coverage/


  # ------------------------------------------------------------------------------