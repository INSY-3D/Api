name: CI Workflow


# ------------------------------------------------------------------------------


on:
  push:
  pull_request:
    types: [ opened, synchronize, reopened ]


# ------------------------------------------------------------------------------


concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true


# ------------------------------------------------------------------------------


jobs:

  # Job
  validate:
    name: Validate Conventions
    runs-on: ubuntu-latest
    timeout-minutes: 1
    steps:

      # Step
      - name: Branches
        shell: bash
        run: |
          BRANCH_NAME="${GITHUB_HEAD_REF:-${GITHUB_REF#refs/heads/}}"

          echo "üîç Validating branch: $BRANCH_NAME"
          
          if [[ "$BRANCH_NAME" =~ ^(main|staging|topic\/[a-z0-9-]+|debug\/[a-z0-9-]+|tests\/[a-z0-9-]+|rollback\/[a-z0-9-]+|refs\/tags\/v[0-9]+\.[0-9]+\.[0-9]+)$ ]]; then
            echo "‚úÖ Follows accepted conventions."
            exit 0
          else
            echo "‚ùå Invalid branch name: '$BRANCH_NAME'                  "
            echo "Allowed conventions:                                    "
            echo "  - main                                                "
            echo "  - staging                                             "
            echo "  - rollback/<lowercase-name> (letters, numbers, dashes)"
            echo "  - topic/<lowercase-name> (letters, numbers, dashes)   "
            echo "  - debug/<lowercase-name> (letters, numbers, dashes)   "
            echo "  - tests/<lowercase-name> (letters, numbers, dashes)   "
            echo "  - refs/tags/vX.Y.Z (semantic version tags)            "
            exit 1
          fi


  # Job
  security:
    name: Dependency Scanner
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    continue-on-error: true
    timeout-minutes: 5
    permissions:
      pull-requests: write
      contents: read
    steps:

      # Step
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      # Step
      - name: VCS Scan
        uses: actions/dependency-review-action@v4
        with:
          fail-on-severity: high


  # Job
  node-build:
    name: Build
    runs-on: ubuntu-latest
    needs: [ validate, security ]
    if: |
      always() && (
        needs.validate.result == 'success' ||
        github.event_name == 'pull_request'
      )
    timeout-minutes: 5
    steps:

      # Step
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      # Step
      - name: Setup the NodeJs Environment
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # Step
      - name: Execute Commands
        shell: bash
        run: |
          npm ci --prefer-offline --no-audit --no-fund
          npm run build
  

  # Job
  node-audit:
    name: Audit
    runs-on: ubuntu-latest
    needs: node-build
    if: always()
    continue-on-error: true
    timeout-minutes: 5
    steps:

      # Step
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      # Step
      - name: Setup the NodeJs Environment
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      # Step
      - name: Install DependenciesS
        shell: bash
        run: |
          npm ci --prefer-offline --no-audit --no-fund

      # Step
      - name: Validate Dependencies
        shell: bash
        run: |
          AUDIT_JSON=$(npm audit --json || true)

          LEVEL_H=$(echo "$AUDIT_JSON" | jq '.metadata.vulnerabilities.high')
          LEVEL_M=$(echo "$AUDIT_JSON" | jq '.metadata.vulnerabilities.moderate')
          LEVEL_L=$(echo "$AUDIT_JSON" | jq '.metadata.vulnerabilities.low')
          LEVEL_I=$(echo "$AUDIT_JSON" | jq '.metadata.vulnerabilities.info')
          
          echo "### Vulnerabilities (Audit)" >> $GITHUB_STEP_SUMMARY

          TABLE="| High | Moderate | Low | Info |\n|:-:|:-:|:-:|:-:|\n| $LEVEL_H | $LEVEL_M | $LEVEL_L | $LEVEL_I |"
          
          echo -e "$TABLE" >> $GITHUB_STEP_SUMMARY
  
  
  # Job
  node-tests:
    name: Tests (NodeJs ${{ matrix.node-version }})
    runs-on: ubuntu-latest
    needs: [ validate, security ]
    if: |
      always() && (
        needs.validate.result == 'success' ||
        github.event_name == 'pull_request'
      )
    strategy:
      fail-fast: false
      matrix:
        node-version: [ 18, 20 ]
    timeout-minutes: 5
    steps:

      # Step
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 1

      # Step
      - name: Setup the NodeJs Environment
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
          cache: npm

      # Step
      # ----
      # This step will run the Unit Test suite via Jest.
      # If no tests are implemented, this step will still succeed. Once finished
      # an artifact will always be uploaded for each concurrent matrix with test
      # results in a plain-text format.
      # ----
      - name: Execute the Jest Unit Testing
        shell: bash
        run: |
          npm ci --prefer-offline --no-audit --no-fund
          mkdir -p test-results coverage
          npm test -- --coverage --passWithNoTests --json --outputFile=test-results/jest-results.json
          npx jest --coverageReporters=text-summary > test-results/coverage-summary.txt || true

      # Step
      - name: Upload Artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: jest-test-results-node-${{ matrix.node-version }}
          retention-days: 7
          path: |
            test-results/
            coverage/


# ------------------------------------------------------------------------------
